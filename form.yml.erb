# Batch Connect app configuration file
#
# @note Used to define the submitted cluster, title, description, and
<%-
  cmd = "/usr/bin/sacctmgr show associations user=$USER -P -n format=account,qos"
  begin
    output, status = Open3.capture2e(cmd)
    if status.success?
      raw_data = output
    else
      raise output
    end
  rescue => e
    qos = []
    qerror = e.message.strip
  end
-%>

---

cluster: "quests"

form:
  # What version of R do you want to run
  - version
  # What other external dependencies do you need to load into your environment
  - other_modules
  # This allows the user to select which partition they submit to
  - slurm_partition
  # This allows a user to request a GPU
  - gres_value
  # This allows a user to specify the account they are submitting under
  - slurm_account
  # This allows a user to use more than 1 core
  - num_cores
  # This allows a user to request RAM
  - memory_per_node
  # How many hours do you want to run this job for
  - bc_num_hours
  # User can supply e-mail if they would like to be e-mailed when the session begins
  - user_email
  # Name of the Slurm job
  - job_name
  # this variable if for the JavaScript
  - raw_data

attributes:
  version:
    widget: select
    label: "Version of R to run in RStudio Server"
    help: "This defines the version of R you want to run in RStudio Server."
    options:
      - [ "R-4.0.0", "R/4.0.0" ]
      - [ "R-4.0.3", "R/4.0.3" ]
      - [ "R-4.1.0", "R/4.1.0" ]
      - [ "R-4.1.1", "R/4.1.1" ]
      - [ "R-4.2.0", "R/4.2.0" ]

  other_modules:
    label: "List of other modules you want to load into your RStudio Server environment."
    help: |
     For example, you might want to load `geos/3.8.1` so that one can install and use the `rgeos` R packages."
    value: ""

  job_name:
    label: "Name of the Job"
    value: "RStudio Server"

  bc_num_hours:
    label: "Wall Clock Time"
    help: |
      The maximum number of hours the Jupyter sessions will run for. You can always terminate your jupyter session early, but it will automatically be terminated by Slurm once the walltime is hit.
    value: 1

  slurm_partition: 
    label: "SLURM Partition"
    help: |
      The SLURM partition you want to submit to. This selection will influence which accounts you can choose as some partition can only be submitted to through certain accounts.
    widget: select

  slurm_account:
    label: "SLURM Account/Project Name"
    help: |
      The SLURM account (i.e., the value of the -A or --account flag used when submitting a SLURM job).
    widget: select

  gres_value:
    label: "Type of GPU that you would like to request"
    help: |
      If you are submitting to `gengpu` the only option that you can select is `A100`.
    widget: select
    default: ""
    options:
      - [ "A100", "gpu:a100:1" ]
      - [ "V100", "gpu:v100:1" ]
      - [ "A30", "gpu:a30:1" ]

  num_cores:
    widget: "number_field"
    label: "Number of CPUs/cores/processors"
    value: 1
    help: |
      Please note that you likely do not need to request more than a single CPU unless you know that your application can be parallelized and also please note that the more cores requested, the longer the wait for the session to start.
    min: 1
    max: 64
    step: 1
    id: 'num_cores'

  memory_per_node:
    widget: "number_field"
    label: "Total memory or RAM do you need in GB."
    value: 5
    help: |
      How much total memory or RAM do you need in GB.
    min: 0
    max: 250
    step: 1
    id: 'memory_per_node'

  user_email:
    label: "Email Address (Optional)"
    help: |
      Enter your email address if you would like to receive an email when the session starts. Leave blank for no email.

  raw_data:
    label: "Account associations for use by JavaScript"
    widget: hidden_field
    value: "<%= raw_data %>"
    cacheable: false
